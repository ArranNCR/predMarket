---
title: "Put Your Money Where Your Mouth Is: Prediction Markets and Climate Change"
author: "John J. Nay, Martin Van der Linden, Jonathan Gilligan"
date: "March 7, 2016"
output: 
  pdf_document:
    keep_tex: true
bibliography: library.bib
---
```{r fig_ref, echo=FALSE}
source("utils/fig_ref.R") # tabRef and figRef functions
source("utils/multi_plot.R")
``` 
```{r, caption_setting, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(knitr)
knit_hooks$set(htmlcap = function(before, options, envir) {
  if(!before) {
    paste('<p class="caption">',options$htmlcap,"</p>",sep="")
    }
    })
# small margins
knit_hooks$set(small_mar = function(before, options, envir) {
    if (before) par(mar = rep(0.0001, 4))  # smaller margins all around
})
# opts_chunk$set(dev="tiff", 
#                dev.args=list(compression="lzw", type="cairo"),
#                dpi=300)
```
```{r multi_plot, echo=FALSE}
source("utils/multi_plot.R")
library(ggplot2)
theme_set(theme_classic())
library(pander)
```

# Abstract

We present a simulation of a climate prediction market. Traders adapt their beliefs about future global temperatures based on the monetary performance of their neighboring traders in a social network. We conduct experiments with the model to determine how a variety of market factors and the climate data-generating process affect whether climate prediction markets foster a convergence of market participants' beliefs regarding a true model of the global climate.

# 1. Introduction

The climate change debate has become strongly polarized over the past twenty years. Although the scientific consensus on the anthropogenic nature of climate change strongly increased, beliefs about anthropogenic climate change did not evolve much within the public [@Vandenbergh2013f]. In addition, the divide on anthropogenic climate change between liberals and conservatives has grown steadily as the question is becoming increasingly politicized and potentially disconnected from scientific evidence. The costs of misinformed climate policies are high. If anthropogenic climate change is a myth but is taken to be true, public resources will be spent on unnecessary efforts. On the other hand, if climate change is human-induced but not recognized as so, the costs of inaction could be devastating. Given that effective climate policies require long-lasting measures to be taken, the importance of an accurate consensus on the issue is manifest.

Attempts to foster such consensus face many social and psychological challenges, some of which could be adressed by creating climate prediction markets where participants can "put their money where their mouths are" [@Hsu2011; @Vandenbergh2013f]. The idea of using prediction markets to efficiently aggregate information about uncertain events has been widely discussed [@Horn2014c]. Prediction markets have been shown to have interesting theoretical properties [@Set1998; @Hanson2012] and to perform well in terms of prediction accuracy and information aggregation in experiments [@Hanson2006; @Healy2010], simulation models [@Klingert2012c; @Jumadinova2011a], and the real-world [@Wolfers2006]. We simulate a prediction market where traders exchange securities related to climate outcomes to explore whether, and under what market and climate conditions, prediction markets may be useful for increasing convergence of climate beliefs.

# 2. Related Work

@Tseng2010a create an agent-based model (ABM) of a continuous double auction market with various types of market strategies, including two variants of the zero-intelligence agent. They compare the behavior of their simulation with data from a prediction market for the outcome of political elections. They find that despite their simplicity, zero-intelligence agents capture some salient features of real market data. @Klingert2012c reach similar conclusions with respect to experimental data from @Hanson2006. In their simulation, @Klingert2012c compare continuous double auctions with logarithmic market scoring rules and find that the latter generally outperform continuous double auctions in terms of prediction accuracy. In some variants of the two last models, agents' strategies feature learning, but these are rather basic and unrelated to a formal predictive model.

@Jumadinova2011a conducted research more similar to ours, as they explicitly include information about uncertain events in their model. @Jumadinova2011a study a continuous double auction model in which agents update their beliefs about the uncertain events based on information on the event. New beliefs are modeled as a weighted sum of the last period's beliefs and market prices. The agents' information set changes every period. The better the information set, the more likely the agent is to put higher weight on last period's prices when revising their beliefs. Little structure is imposed on the information set and the way it is used to generate the weights in the update function. Therefore, the model does not allow for investigating the convergence of predictive models. @Ontanon2009 study the effect of deliberation on a simulated prediction market. They assume that agents use Case-Based Reasoning [@Aamodt1994] to reason and debate about uncertain outcomes with their neighbors in a social network. Although the model could in theory be used to assess convergence of predictive models by looking at the arguments agents adopt after the deliberation, this is not done by the authors. Also, the way beliefs are formed and revised through argumentation is too abstract for studying climate prediction markets, where beliefs should be based on statistical time series models.

To the best of our knowledge, the idea that prediction markets can generate consensus *on the factors* affecting uncertain events has never been quantitatively explored. ABMs of prediction markets have been studied [@Klingert2012c; @Tseng2010a; @Jumadinova2011a], some of which feature communication between agents. In these models, however, beliefs about the uncertain outcomes are constructed in rather abstract ways. In particular, beliefs are not based on structural models from which agents could derive causal implications, and therefore these models are not suitable for investigating the convergence of the underlying explanatory models agents employ for prediction.

From a public policy perspective, changing the explanatory models of market participants is one of the most important roles that prediction markets might play. This is perhaps the most important social benefit of prediction markets given the comparable predictive power of statistical supervised learning models, which can provide information at a much lower cost than creating and maintaining a prediction market [@goel_prediction_2010]. Effective climate policy not only requires an accurate consensus on future climate *outcomes*. It also requires an accurate consensus on the causal *mechanisms* influencing such outcomes. If people agree that temperature will rise, but some believe it will be due to greenhouse gases, while others believe that it will be caused by increased solar activity, inconsistent and ineffective policies may be implemented.

# 2. Model Design

Traders bet on global temperature anomalies six years in the future. During the six-year period, traders buy and sell futures. Every year, traders update their models and forecast future temperature based on the current year's temperature. At the end of each six-year period, winners collect money and traders revise beliefs about climate models, based on their ideology and the beliefs of top earners in their social network. In this section, we describe the models used to generate future temperature data, agents beliefs about those models, the market procedures, and the social network connecting agents. We conclude with details on model dynamics and an overview of the model parameters.

## Temperature Models

We start with the historical temperature record and project future climates under two alternative theories: 

Temperature proportional to log(CO2) or Total Solar Irradiance (conventional science vs. popular alternative among doubters). Add AR(1) noise (best ARMA noise model for historical record).

JG - describe the temperature time series models here. Add the plots of the time series diverging thats on middle of poster. Add citations for the models to library.bib.

## Climate Beliefs

Traders use one of the two models (temperature depends on CO2 or TSI) to forecast future temperature anomalies. These models are interpreted as the trader's beliefs about the true climate process, the driving factor of long-term global temperatures. They represent pervasive positions on climate change in the public debate. In order to approximatively match the current configuration of beliefs in climate change in the United States, model 1 is randomly assigned to half of the traders, while 2 is assigned to the other half of the traders.

Thus, both when **true.model** = 0 and **true.model** = 1, approximately half of the traders use the true data-generating model to make predictions. However, traders using the true model do not necessarily make perfectly accurate predictions. Although these traders believe in the correct *functional form* of the model, they still need to calibrate it based on limited noisy data. Therefore, the values they use as the parameters of the model will typically still be different from the exact parameters of the data-generating process.

## Traders and Market

Traders are initially endowed with a single unit Experimental Currency Unit (ECU). Traders use their model to forecast the distribution of future temperatures and determine their reservation price for different securities. Securities pay 1 ECU  if the actual temperature at some time $t^*$ falls between a certain range. Traders are risk-neutral expected utility maximizers. Therefore, their reservation price for a security $\tilde{s}$ is simply their assessment of the probability that the temperature at time $t^*$ falls in the range covered by $\tilde{s}$.
 		
Based on their reservation price, traders behave as "zero-intelligence" agents [@Gode1993], that is, they sell at a random price above their reservation, and buy at a random price below their reservation. The distribution from which buy and sell prices are drawn is determined by the traders risk attitude, characterized by parameter $risk.tak_i$. These trading strategies are simple but have been shown to provide accurate approximations of behavior in prediction markets [@Klingert2012c], and in financial markets more broadly.

Our model features a particular version of CDA through which traders exchange securities. Continuous-double auctions (CDAs) or some variants thereof are common market mechanisms, i.e. procedures to match buy and sell orders. CDA are notably used on large stock markets [@Tseng2010a].
 
## Social Network

Traders are part of a social network where each agent forms two links at random, and then forms links randomly. This ensures that each agent is connected to at least two other agents. Every time a security is realized, each trader $i$ looks at the performance of their neighbors in the network. If one of $i$'s neighbors, say $j$, is richer than $i$, $i$ interprets this has an indication that $j$ has a better approximate model. Then $i$ considers adopting $j$'s approximate model. Traders start with the same initial amount of money, so differences in money among traders can only come from  traders' interactions through the market. For each trader, the willingness to revise her belief is determined by how ideologically loaded her belief is, which is characterized by parameter $ideo_i$.

![Network](output/network.pdf)
 
An example of such social network is depicted in Figure X. We assume that the initial network is segregated, that is, traders who believe in model 2 (1) are more likely to be linked with other traders who believe in 2 (1). The degree of segregation is determined by parameter **seg**. Although traders can change their approximate model over time, the connections between traders do not change as the market unfolds -- the edges are fixed.

## Model Dynamics

The time periods, $t$, are grouped in trading *sequences*. In a given sequence, the potential payments associated with traded securities are all based on the temperature at the end of the sequence. For instance, the third trading sequence might start in period $t = 1964$ and end in period $t = 1970$. In this case, a security traded in the third sequence pays 1 ECU if the temperature at $t = 1970$ falls into the range of temperatures covered by the security. At each time $t$, traders are assumed to know the past value of the temperature $\hat{T}_{0:t}$ and greenhouse gas emissions  $GHG_{0:t}$. In a sequence finishing at time $t^*$,  traders also have common knowledge of $GHG_{t:t^*}$, the future values of greenhouse gas emissions up to $t^*$. However, at any $t$, traders do not know the value of any future temperatures. In particular, in a given sequence, traders do not know the value of $\hat{T}_{t^*}$. Traders can only predict $\hat{T}_{t^*}$ using their approximate model and their knowledge of $\hat{T}_{0:t}$ and  $GHG_{0:t^*}$. Notice that because $GHG_{0:t^*}$ is common knowledge, in each period $t$ every trader $i$ with the same approximate model forms the same pseudo-expectation $\mu_{ti} \equiv E_t( \hat{T}_{t^*} ~|~ \hat{T}_{0:t}, GHG_{0:t^*})$, $i$'s approximate model at $t$.
 	   
We assume that the believed probability distribution of $\hat{T}_{t^*}$ for trader $i$  at any time $t$ is $\mu_{ti} + \eta_t$, where the distribution $\eta_t$ is obtained by trader $i$ by bootstrapping the residuals from the regression of her believed true model over the past periods. This explains the use of the term pseudo-expectation. Because $\eta_t$ is not bound to have expected value zero, a traders' effective expected value of $\hat{T}_{t^*}$ may be different from $\mu_{ti}$.       
 	   
 At each time $t$, traders follow this process:

1. recalibrate their approximate model based on the new set of past data available at $t$,
2. compute their belief-density for $\hat{T}_{t^*}$ and use it to determine the expected value they attached to each security,
3. and trade on the CDA market based on their zero-intelligence decision rule as follows. 
 	+ Every trader $i$ choses at random a security $s_i^B$ she will try to buy.
 	+ Every trader $i$ also chooses at random among the securities she owns a positive amount of (if any) a security $s_i^S$ she will try to sell.
	+ Traders then decide of their selling $p_i^S$ and buying price $p_i^S$. To do so, they compute the expected value of the securities $s_i^B$ and $s_i^S$. Then they set a selling and a buying price following the zero-intelligence rule.
	+ Traders go to the market one at the time, in an order randomly selected each $t$.
 	+ When $i$ comes to the market, she places limit orders in the order book. These orders specify that $i$ is willing to buy $s_i^B$ at any price below $p_i^B$, and to sell $s_i^S$ at any price above $p_i^S$.
 	+ The market maker then tries to match $i$'s orders with some order which was put in the order book before $i$ came to the market.
 	+ If there are  outstanding sell offers for $s_i^B$ at price $p$ lower than $p_i^B$, then a trade is concluded. Trader $i$ buys one unit from the sellers who sells at the highest price below $p_i^B$, and the sell and buy offers are removed from the order book.
 	+ If there are  outstanding buy offers for $s_i^S$ at price $p$ higher than $p_i^S$, then a trade is concluded. Trader $i$ sells one unit to the buyer who buys at the highest price above $p_i^S$, and the  sell and buy offers are removed from the order book.
 	+ Whenever all traders have come to the market, any remaining outstanding offer is removed from the order book, and the trading period is concluded. 
 	
At $t^*$, when the sequence ends, there is only one security $s^*$ associated with a range of temperatures including the actual $\hat{T}_{t^*}$. Thus:

1. traders receive 1 ECU per unit of $s^*$ they own, and
2.  consider adapting their neighbors' approximate model as described above.
 	
## Model Parameters
 	
The model depends on the following parameters, which we vary in simulation experiments to determine their effects on the convergence of beliefs. 

* Network parameters:
    + **n.traders**: the number of traders.
    + **n.edg**: the number of edges in the social network.
    + **seg**: the initial degree of homophily in the network. The higher **seg**, the higher the initial homophily. 
 		
 * Market structure parameters:
    + **market.complet** the number of securities which can be traded. With more securities, the interval of temperatures corresponding to each security is smaller. Traders can then trade on more precise temperature intervals. Higher values of **market.complet** may, however, reduce the number of exchanges. Because traders pick the securities they buy and sell at random, the probability that a match between sellers and buyers is found is lower for higher values of **market.complet**.
    
* Behavioral parameters.
    + **risk.tak** Determines the distribution of risk-taking behavior. The higher risk.tak, the more traders	will try to buy (resp. sell) lower (resp. higher) than their reservation price. Formally, at time $t$, trader $i$ picks her buying (resp. selling) prices randomly in the interval  $[\texttt{reserv}_{it}, \allowbreak \texttt{reserv}_{it}  * (1 - \texttt{risk.tak}_i)]$ (resp. $[\texttt{reserv}_{it}, \allowbreak \texttt{reserv}_{it} * (1  + \texttt{risk.tak}_i)]$), where $\texttt{reserv}_{it}$ is $i$'s reservation price at time $t$ for the security $i$ picked to buy (resp. sell). For each trader $i$, the level of \texttt{risk.tak}$_i$ is drawn uniformly at random from $[0,$\texttt{risk.tak} $]$
    + **ideo**  Determines the degree of "ideology" of traders. If ideo is high, traders will not revise their approximate models easily, even when faced with strong evidence that their neighbors are doing better than them. For each trader $i$ and each sequence, a parameter $d_{i}$ is drawn from $[0, \texttt{ideo}_i]$. The value of $d_{i}$ is the probability that $i$ adopts one of her neighbors' approximate model if this neighbor is doing better than $i$ at the end of the sequence (in monetary terms).
    
IM GOING TO DELETE THESE 3 bc we set them:
* Timing parameters
    + **burn.in** The number of burn-in periods in which no securities are traded (necessary to allow believed models to be estimated in the first period).
    + **n.seq** Number of trading sequences.
    + **horizon** Number of trading periods in each trading sequence.

# 3. Results

## Historical Data

As a validation that the market is operating correctly, we run the market with actual temperatures 1880 to 2015 and market betting from 1931 to 2014. As warming signal begins to show up in 1980s, traders begin to converge toward log(CO2) model `r figRef("time")`.

## Future Scenarios

The sensitivity analysis is based on a Latin Hypercube Sampling of parameter sets from the following distributions [@beachkofski_improved_2002; @carnell_lhs_2012]. 

* ideo $\sim Unif(0,1)$
* market.complet $\sim Unif(0,1000)$ (mapped into integer)
* n.edge $\sim Unif(100,200)$ (mapped into integer)
* n.traders $\sim Unif(50,250)$ (mapped into integer)
* risk.tak  $\sim Unif(0,1)$
* seg $\sim Unif(0,1)$
* true.model $\sim Binom(0.5)$

We use the model to simulate 10,000 outcomes based on the input paramter sets and then conduct a partial rank correlation coefficient analysis on the relationship between the input matrix, $X$, resulting simulated vector, $y$ [@Marino2008; @pujol_sensitivity:_2014; @saltelli_sensitivity_2009]. Partial correlation computes the linear relationship between the part of the variation of $X_i$ and $y$ that are linearly independent of other $X_j$  ($j \neq i$).  The only difference with the partial correlation and partial rank correlation (which we use here), is that the outcome variable $y$ is first ranked-transformed in order to allow us capture potentially non-linear relationships. That is every value, $y_s$, in the data set is replace by a number $f(y_s) \equiv |\{y_r~|~ y_s > y_r\}|$, where $y_r$ are the other observed values of $y$ in the data set.

Our sensitivity analysis, `r figRef("sa")`, shows that ideology, risk tolerance, the number of traders, and the segmentation of the social network significantly affect convergence. Segmented social networks can create an "echo-chamber" effect.

```{r sa, eval=TRUE, echo=FALSE, message=FALSE, htmlcap=figRef("sa", "Estimated effects of model parameters on convergence of beliefs in future scenario."), fig.width=3, fig.height=3.5}
# library(eat)
# load("output/src_future.Rda")
# plot(src_future, outcome_var = "Convergence") + theme_classic() + theme(text=element_text(family='Palatino'))

source("utils/sa_plot.R")
sa_plot() + theme(text=element_text(family='Palatino'))
#multi_plot(p1, p2, cols = 2)
```


```{r time, eval=TRUE, echo=FALSE, message=FALSE, htmlcap=figRef("time", "Convergence over trading sequences."), fig.width=10.5, fig.height=8.5}
source("utils/time_plot.R")
p1 <- history_box() + theme(text=element_text(family='Palatino'))
p2 <- future_box() + theme(text=element_text(family='Palatino'))
multi_plot(p1, p2, cols=2)
```

```{r sa2, eval=TRUE, echo=FALSE, message=FALSE, htmlcap=tabRef("sa2", "")}

```

 `r tabRef("one")` 


# 4. Discussion

Our code for the model is available at [johnjnay.com/predictMarket](http://johnjnay.com/predictMarket).

Existing prediction markets (e.g. hypermind.com, betfair.com, and predictit.org) focus on nearer term events (months in advance), but have been shown to have performance superior to statistical models for some event types [@pathak_comparison_2015].

# Acknowledgements

We would like to thank Yevgeniy Vorobeychik for feedback on this project.

# References

```{r, finalize, eval=TRUE, echo=FALSE}
# Print out warnings if we did not use all the figures.
if(!all(environment(figRef)$created)){
    missingFig <- which(!environment(figRef)$created)
    warning("Figure(s) ", paste(missingFig, sep=", "), " with label(s) '", 
      paste(names(environment(figRef)$created)[missingFig], sep="', '"),
      "' are referenced in the text but have never been created.")
}
if(!all(environment(figRef)$used)){
    missingRef <- which(!environment(figRef)$used)
    warning("Figure(s) ", paste(missingRef, sep=", "), " with label(s) '", 
      paste(names(environment(figRef)$used)[missingRef], sep="', '"),
      "' are present in the document but are never referred to in the text.")
}
```
